document.addEventListener('DOMContentLoaded', async () => {
    // 1. CONFIGURACI√ìN SUPABASE
    const SUPABASE_URL = 'https://ymvpaooxdqhayzcumrpj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_TdMi6H9GkduboyrDAf0L3g_Ct5C7Wqy';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const CLAVES_VALIDAS = ['29931335', '24175402'];
    let participantes = [];
    let resultados = [];
    let finanzas = { ventas: 0, recaudado: 0.00, acumulado: 0.00 };

    // 2. BLOQUEO DE ACCESO
    const clave = prompt("üîê Acceso Administrativo - MEGA POLLA\nIngrese su clave:");
    if (!CLAVES_VALIDAS.includes(clave)) {
        alert("Acceso denegado.");
        window.location.href = "index.html";
    }

    // 3. CARGA DE DATOS (TABLA √öNICA polla_datos)
    async function cargarDatos() {
        const { data, error } = await _supabase.from('polla_datos').select('*');
        if (error) return console.error("Error al cargar:", error);

        data.forEach(item => {
            if (item.tipo === 'participantes') participantes = item.contenido || [];
            if (item.tipo === 'resultados') resultados = item.contenido || [];
            if (item.tipo === 'finanzas') finanzas = item.contenido || finanzas;
        });
        renderTodo();
    }

    async function guardarEnNube(tipo, contenido) {
        await _supabase.from('polla_datos').upsert({ tipo, contenido }, { onConflict: 'tipo' });
    }

    // 4. PROCESADOR DE WHATSAPP (Pegado R√°pido)
    document.getElementById('btn-procesar-pegado').onclick = () => {
        const rawText = document.getElementById('input-paste-data').value;
        const lineas = rawText.split('\n').map(l => l.trim());
        
        let nombreDetectado = "";
        let refeDetectado = "";
        let jugadasEncontradas = [];

        lineas.forEach(linea => {
            // Buscar grupos de 7 n√∫meros
            const nums = linea.match(/\b\d{2}\b/g);
            if (nums && nums.length >= 7) {
                // Si hay m√°s de 7, los separa en grupos
                for (let i = 0; i <= nums.length - 7; i += 7) {
                    jugadasEncontradas.push(nums.slice(i, i + 7).join(','));
                }
            } else if (linea.toLowerCase().includes("identificaci√≥n:") || linea.toLowerCase().includes("refe:")) {
                const idMatch = linea.match(/\d+/);
                if (idMatch) refeDetectado = idMatch[0];
            } else if (linea.length > 3 && isNaN(linea[0]) && !nombreDetectado) {
                nombreDetectado = linea.toUpperCase();
            }
        });

        document.getElementById('nombre').value = nombreDetectado;
        document.getElementById('refe').value = refeDetectado;
        document.getElementById('jugadas-procesadas').value = jugadasEncontradas.join(' | ');
        alert("‚úÖ Datos procesados. Revise los campos antes de registrar.");
    };

    // 5. REGISTRO DE PARTICIPANTES
    document.getElementById('form-participante').onsubmit = async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value.trim();
        const refe = document.getElementById('refe').value.trim();
        const jugadasRaw = document.getElementById('jugadas-procesadas').value.split('|');

        jugadasRaw.forEach(grupo => {
            const numeros = grupo.split(',').map(n => n.trim());
            if (numeros.length === 7) {
                participantes.push({
                    nombre: nombre.toUpperCase(),
                    refe: refe,
                    jugada: numeros
                });
            }
        });

        await guardarEnNube('participantes', participantes);
        document.getElementById('input-paste-data').value = "";
        e.target.reset();
        cargarDatos();
    };

    // 6. RESULTADOS DEL SORTEO
    document.getElementById('form-resultados').onsubmit = async (e) => {
        e.preventDefault();
        const sorteo = document.getElementById('sorteo-hora').value;
        const numero = document.getElementById('numero-ganador').value.padStart(2, '0');

        resultados.push({ sorteo, numero });
        await guardarEnNube('resultados', resultados);
        e.target.reset();
        cargarDatos();
    };

    // 7. GESTI√ìN DE FINANZAS
    document.getElementById('form-finanzas').onsubmit = async (e) => {
        e.preventDefault();
        finanzas = {
            ventas: document.getElementById('input-ventas').value,
            recaudado: document.getElementById('input-recaudado').value,
            acumulado: document.getElementById('input-acumulado').value
        };
        await guardarEnNube('finanzas', finanzas);
        alert("üí∞ Finanzas actualizadas correctamente.");
    };

    // 8. RENDERIZADO Y BUSCADOR
    function renderTodo() {
        // Render Resultados
        const listaR = document.getElementById('lista-resultados');
        listaR.innerHTML = resultados.map((r, i) => `
            <li>
                <span><strong>${r.sorteo}:</strong> ${r.numero}</span>
                <button class="btn-eliminar" onclick="eliminarR(${i})">Eliminar</button>
            </li>
        `).join('');

        // Render Participantes con buscador
        renderParticipantes();

        // Cargar montos en inputs
        document.getElementById('input-ventas').value = finanzas.ventas;
        document.getElementById('input-recaudado').value = finanzas.recaudado;
        document.getElementById('input-acumulado').value = finanzas.acumulado;
    }

    function renderParticipantes() {
        const query = document.getElementById('input-buscar-participante').value.toLowerCase();
        const listaP = document.getElementById('lista-participantes');
        
        const filtrados = participantes.filter(p => 
            p.nombre.toLowerCase().includes(query) || p.refe.includes(query)
        );

        listaP.innerHTML = filtrados.map((p, i) => `
            <li>
                <div>
                    <strong>${p.nombre}</strong> (Ref: ${p.refe})<br>
                    <small>${p.jugada.join(' - ')}</small>
                </div>
                <button class="btn-eliminar" onclick="eliminarP(${i})">Eliminar</button>
            </li>
        `).join('');
    }

    // Funciones globales para botones
    window.eliminarP = async (i) => {
        if(confirm("¬øEliminar esta jugada?")) {
            participantes.splice(i, 1);
            await guardarEnNube('participantes', participantes);
            cargarDatos();
        }
    };

    window.eliminarR = async (i) => {
        if(confirm("¬øEliminar este resultado?")) {
            resultados.splice(i, 1);
            await guardarEnNube('resultados', resultados);
            cargarDatos();
        }
    };

    // Reiniciar Sistema
    document.getElementById('btn-reiniciar-datos').onclick = async () => {
        if (confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO? Se borrar√°n TODOS los datos.")) {
            const pass = prompt("Confirma con tu clave:");
            if (CLAVES_VALIDAS.includes(pass)) {
                await guardarEnNube('participantes', []);
                await guardarEnNube('resultados', []);
                await guardarEnNube('finanzas', { ventas: 0, recaudado: 0, acumulado: 0 });
                location.reload();
            }
        }
    };

    document.getElementById('input-buscar-participante').oninput = renderParticipantes;

    cargarDatos();
});